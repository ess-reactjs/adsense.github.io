var de=Object.defineProperty;var ue=(r,e,s)=>e in r?de(r,e,{enumerable:!0,configurable:!0,writable:!0,value:s}):r[e]=s;var U=(r,e,s)=>(ue(r,typeof e!="symbol"?e+"":e,s),s);import{af as fe,j as t,b0 as me,l as H,s as pe,r as d,a5 as he,aC as xe,J as Ce,a9 as v,x as ge,B as M,ci as ve,cj as be,ck as j,cl as J,cm as je,cn as we,co as Se,q as ye,a as Ie,aE as Ne,Y as De,b as Ee,cp as ke,cq as G,V as Pe,S as Ae,e as Te,ai as Le,cr as Re,cs as Be,L as Fe,aJ as Ue,ct as Ge,cu as Me}from"./index-W2AL0DnC.js";import{C as _,a as Ke}from"./Carts-D77_trR1.js";import{C as K}from"./carts-Cqi7XGvI.js";import{S as Oe}from"./index-DIHeX8hj.js";import"./index-CvloCrzG.js";import"./MembershipAPI-D2n6KU8D.js";import"./use-loading-progress-B3ewIWgk.js";import"./index-BmvmerTs.js";const Ve=({children:r,id:e,item:s,type:o})=>{const{isOver:u,setNodeRef:l}=fe({id:e,data:{type:o,item:s}}),f={border:u?"2px dashed purple":"2px dashed transparent",backgroundColor:u?"#f2f2f2":"transparent",borderRadius:"8px"};return t.jsx("div",{ref:l,style:f,children:r})},qe=({item:r,type:e,cart:s,isChecked:o,onCheckboxChange:u})=>t.jsx(_,{item:r,type:e,cart:s,children:t.jsx("div",{className:"flex h-full cursor-pointer items-center",onClick:l=>{l.preventDefault(),l.stopPropagation()},children:t.jsx(me,{label:"",isChecked:o,onChange:u,style:"square"})})}),ze=({cart:r,closeCart:e})=>{const s=r.cartItems??[],{refetchCarts:o}=H(),{refetch:u}=pe(!1,!1),[l,f]=d.useState({}),D=he({onSuccess:()=>{o(),e(!1)},onError:()=>{v.error("Something went wrong. Please refresh and try again.",{toastId:2,type:"error"})}}),h=xe({onSuccess:()=>{e(!0),o(),u(),v.success("Successfully confirmed purchase",{toastId:1,type:"success"})},onError:()=>{v.error("Something wrong happened",{toastId:2,type:"error"})}}),m=()=>{const n=Object.keys(l).filter(g=>l[g]);h.mutate({cartId:r.id,confirmedIds:n})};d.useEffect(()=>{if(s){const n={};s.forEach(g=>{n[g.id]=!0}),f(n)}},[s]);const C=n=>{f(g=>({...g,[n]:!g[n]}))},c=()=>{D.mutate({cartId:r.id})},i=()=>{var n;return t.jsxs("div",{className:"flex w-full justify-between ",children:[t.jsx("div",{className:"w-20",children:t.jsx(ge,{store:r.storeName})}),t.jsx("div",{className:"text-lg font-bold text-purple-500",children:(n=r.totalPrice)==null?void 0:n.displayValue})]})},x=()=>t.jsxs(t.Fragment,{children:[t.jsxs("div",{className:"text-base text-white-600",children:["(",s==null?void 0:s.length,") product",s!=null&&s.length&&(s==null?void 0:s.length)>1?"s":""]}),t.jsx("div",{className:" overflow-auto py-4 md:h-auto md:max-h-screen",children:s&&s.map(n=>t.jsx(qe,{cart:r,item:n,type:K.PENDING,isChecked:l[n.id],onCheckboxChange:()=>C(n.id)},n.id))}),t.jsxs("div",{className:"flex justify-between",children:[t.jsx("div",{className:"flex min-w-36",children:t.jsx(M,{colorTheme:"purple",variant:"bare",onClick:c,children:"Continue Shopping"})}),t.jsx("div",{className:"flex w-36",children:t.jsx(M,{colorTheme:"green",variant:"filled",onClick:m,children:"Confirm"})})]})]});return t.jsx(t.Fragment,{children:t.jsx(Ce,{defaultExpanded:!0,title:t.jsx(i,{}),content:t.jsx(x,{})})})};class Q extends ve{}U(Q,"activators",[{eventName:"onMouseDown",handler:({nativeEvent:e})=>Z(e.target)}]);class X extends be{}U(X,"activators",[{eventName:"onKeyDown",handler:({nativeEvent:e})=>Z(e.target)}]);function Z(r){let e=r;for(;e;){if(e.dataset&&e.dataset.noDnd)return!1;e=e.parentElement}return!0}function We(r,e,s){const o={...r};return e.top+r.y<=s.top?o.y=s.top-e.top:e.bottom+r.y>=s.top+s.height&&(o.y=s.top+s.height-e.bottom),e.left+r.x<=s.left?o.x=s.left-e.left:e.right+r.x>=s.left+s.width&&(o.x=s.left+s.width-e.right),o}const Ye=r=>{let{transform:e,draggingNodeRect:s,windowRect:o}=r;return!s||!o?e:We(e,s,o)};function R(r){if(!r)return!1;const e=r.data.current;return!!(e&&"sortable"in e&&typeof e.sortable=="object"&&"containerId"in e.sortable&&"items"in e.sortable&&"index"in e.sortable)}const He=[j.Down,j.Right,j.Up,j.Left],Je=(r,e)=>{let{context:{active:s,collisionRect:o,droppableRects:u,droppableContainers:l,over:f,scrollableAncestors:D}}=e;if(He.includes(r.code)){if(r.preventDefault(),!s||!o)return;const h=[];l.getEnabled().forEach(c=>{if(!c||c!=null&&c.disabled)return;const i=u.get(c.id);if(i)switch(r.code){case j.Down:o.top<i.top&&h.push(c);break;case j.Up:o.top>i.top&&h.push(c);break;case j.Left:o.left>i.left&&h.push(c);break;case j.Right:o.left<i.left&&h.push(c);break}});const m=J({active:s,collisionRect:o,droppableRects:u,droppableContainers:h,pointerCoordinates:null});let C=je(m,"id");if(C===(f==null?void 0:f.id)&&m.length>1&&(C=m[1].id),C!=null){const c=l.get(s.id),i=l.get(C),x=i?u.get(i.id):null,n=i==null?void 0:i.node.current;if(n&&x&&c&&i){const P=we(n).some((S,L)=>D[L]!==S),w=$(c,i),A=_e(c,i),b=P||!w?{x:0,y:0}:{x:A?o.width-x.width:0,y:A?o.height-x.height:0},T={x:x.left,y:x.top};return b.x&&b.y?T:Se(T,b)}}}};function $(r,e){return!R(r)||!R(e)?!1:r.data.current.sortable.containerId===e.data.current.sortable.containerId}function _e(r,e){return!R(r)||!R(e)||!$(r,e)?!1:r.data.current.sortable.index<e.data.current.sortable.index}const ot=()=>{var V,q,z;const{carts:r,isLoading:e,deleteCart:s,refetchCarts:o,moveProduct:u}=H(),{isPending:l}=ye(),{isUpgradeButtonDisabled:f}=Ie(),[D,h]=d.useState(!1),[m,C]=d.useState(null),[c,i]=d.useState(""),[x,n]=d.useState(""),[g,P]=d.useState(!1),[w,A]=d.useState({}),{data:b,isLoading:T,refetch:E}=Ne(),{user:S}=d.useContext(De),[L]=Ee();d.useEffect(()=>{o()},[]);const[I,O]=d.useState([]),ee=ke(G(Q,{activationConstraint:{distance:30}}),G(X,{coordinateGetter:Je}),G(Me,{activationConstraint:{delay:350,tolerance:5}}));d.useEffect(()=>{e||O(r)},[r,O,e]),d.useEffect(()=>{S!=null&&!L.get("code")&&E()},[E,L]);const te=a=>{s(a).then(p=>{p?v.success("Successfully deleted cart",{toastId:1,type:"success"}):v.error("Error deleting, try again later",{toastId:1,type:"error"})}).catch(()=>{v.error("Error deleting, try again later",{toastId:1,type:"error"})})},se=()=>{o(),E()},re=()=>{o(),E()},ae=a=>{const{active:p}=a;C(p)},oe=a=>{const{active:p,over:B}=a,{id:W}=p,{id:ce}=B,Y=[...I],y=Y.find(k=>k.cartItems.some(le=>le.id===W)),N=Y.find(k=>k.id===ce);if((y==null?void 0:y.id)===(N==null?void 0:N.id)||!y||!N)return;const F=y.cartItems.find(k=>k.id===W);F&&(F&&(P(!0),A({product:F,closeDialog:()=>{P(!1)},destinationStore:N.storeName,originalStore:y.storeName,itemReplacement:()=>{}})),i(y.id),n(N.id),C(null))},ne=(a,p)=>{u(a,c,p,x).then(B=>{B?v.success("The product is successfully moved",{toastId:2,type:"success"}):v.error("Error moving the product, try again later",{toastId:3,type:"error"})}).catch(()=>{v.error("Error moving the product, try again later",{toastId:2,type:"error"})})},ie=()=>{h(!1)};return e?t.jsx("div",{className:"m-28",children:t.jsx(Pe,{size:45})}):t.jsxs(t.Fragment,{children:[D&&t.jsx(Ae,{onRedirectComplete:ie}),S&&!((V=S==null?void 0:S.subscription)!=null&&V.isFreePlan)?t.jsx("p",{className:"mb-2 mt-4 text-center text-sm font-medium text-black-400 sm:mt-5 sm:text-start",children:"You can manually drag and drop items between your carts!"}):t.jsxs("p",{className:"mb-2 mt-5 text-center text-xs font-medium text-black-400 sm:text-start",children:["Want to benefit from being able to drag, drop and compare prices across vendors?",t.jsx("button",{className:Te("ml-1",{"text-green-500 underline hover:cursor-pointer":!f,"cursor-not-allowed text-black-300":f}),disabled:f,"aria-disabled":f,onClick:()=>{h(!0)},children:"Go premium"})]}),!l&&!T&&b&&b.rows.length>0&&t.jsx(Le,{shouldShow:b.rows.length>0,onClose:()=>{},children:t.jsxs("div",{className:"flex flex-col flex-wrap",children:[t.jsxs("div",{className:"flex items-center pb-2",children:[t.jsx(Re,{className:"mr-2 text-purple-500"}),t.jsx("div",{className:"mr-2 text-purple-500",children:"Confirm purchase"})]}),t.jsx("div",{className:"flex items-center pb-2",children:t.jsx("div",{className:"text-sm text-white-700",children:"Please confirm that you have purchased the items in this cart on the vendor's website. If you have not, please click on Continue Shopping to keep these items in your cart."})}),b.rows.map(a=>t.jsx("div",{className:"w-full pb-4",children:t.jsx(ze,{cart:a,closeCart:p=>re()})},a.id))]})}),t.jsxs(Be,{onDragStart:ae,onDragEnd:oe,sensors:ee,collisionDetection:J,autoScroll:{layoutShiftCompensation:!0},children:[t.jsx("div",{className:"flex flex-row flex-wrap md:flex-col",children:I&&I.length>0?I.filter(a=>{var p;return a.cartItems&&((p=a.cartItems)==null?void 0:p.length)>0}).map(a=>t.jsx("div",{className:"mb-2 w-1/2 pr-4 md:w-full md:pr-0",children:t.jsx(Ve,{type:"Items",id:a.id,item:a,children:t.jsx(Ke,{cart:a,type:K.ACTIVE,targetCart:x,removeCart:()=>te(a.id),checkoutCart:se},a.id)},a.id)},a.id)):t.jsxs("div",{className:"flex w-full flex-col text-center",children:[t.jsx("div",{className:"w-full p-5 text-center",children:"Your cart is empty"}),t.jsx("div",{className:"flex w-full flex-col items-center",children:t.jsx(Fe,{to:"/",children:t.jsx(M,{colorTheme:"purple",variant:"filled",className:"p-4 px-16",children:"Browse Products"})})})]})}),g&&t.jsx(Oe,{product:w.product,destinationStore:w.destinationStore,originalStore:w.originalStore,closeDialog:w.closeDialog,itemReplacement:a=>ne(w.product.id,a)}),Ue.createPortal(t.jsx(Ge,{wrapperElement:"ul",modifiers:[Ye],zIndex:10,dropAnimation:{duration:500,easing:"cubic-bezier(0.18, 0.67, 0.6, 1.22)"},className:"border-gray-500 mb-10 border border-dashed bg-white-100 font-extrabold text-purple-500 hover:shadow-md",children:m&&t.jsx(_,{cart:I.find(a=>a.id==m.data.current.item),type:K.ACTIVE,item:((z=(q=I.find(a=>a.id==m.data.current.item))==null?void 0:q.cartItems)==null?void 0:z.find(a=>a.id==m.id))??{}},m.id)}),document.body)]})]})};export{ot as default};
